<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Parcelamento</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="container">
    <h1>Calculadora de Parcelamento</h1>

    <form id="calcForm" novalidate>
      
      <div class="input-group">
        <label for="valorProduto">Valor do Produto (R$):</label>
        <input type="number" id="valorProduto" name="valorProduto" min="0" step="0.01" required placeholder="Ex.: 3997,00"/>
      </div>

      <div class="input-group">
        <label for="valorEntrada">Valor de Entrada (R$):</label>
        <input type="number" id="valorEntrada" name="valorEntrada" min="0" step="0.01" required placeholder="Ex.: 500,00"/>
        <p class="muted">A entrada será abatida do valor do produto antes do cálculo.</p>
      </div>

      <div class="input-group">
        <label for="parcelas">Opção de Parcelamento:</label>
        <select id="parcelas" name="parcelas" required>
            <option value="">Selecione a quantidade...</option>
            </select>
        <div id="displayTaxa" class="info-taxa"></div>
      </div>

      <button type="submit">Calcular Parcelas</button>
      
      <div id="resultado" aria-live="polite"></div>
    </form>
  </div>

  <script>
    // ============================================================
    // CONFIGURAÇÃO DAS TAXAS
    // ============================================================
    const TAXAS_JUROS = {
        2:  5.11,
        3:  6.85,
        4:  8.62,
        5:  10.39,
        6:  12.19,
        7:  14.01,
        8:  15.85,
        9:  17.70,
        10: 19.58,
        11: 21.47,
        12: 23.28 // Corrigido de vírgula para ponto para o JS entender
    };
    
    // Formatador BRL
    const fmtBRL = new Intl.NumberFormat('pt-BR', {
      style: 'currency', currency: 'BRL'
    });

    // Elementos do DOM
    const form = document.getElementById('calcForm');
    const resultado = document.getElementById('resultado');
    const elProduto = document.getElementById('valorProduto');
    const elEntrada = document.getElementById('valorEntrada');
    const selectParcelas = document.getElementById('parcelas');
    const displayTaxa = document.getElementById('displayTaxa');

    // 1. Inicializa o Select com as opções da tabela
    function iniciarOpcoesParcelamento() {
        selectParcelas.innerHTML = '<option value="">Selecione a quantidade...</option>';
        for (const [qtd, taxa] of Object.entries(TAXAS_JUROS)) {
            const option = document.createElement('option');
            option.value = qtd;
            option.textContent = `${qtd}x (Taxa: ${taxa.toString().replace('.',',')}%)`;
            selectParcelas.appendChild(option);
        }
    }
    iniciarOpcoesParcelamento();

    // 2. Mostra a taxa selecionada abaixo do campo
    selectParcelas.addEventListener('change', function() {
        const qtd = this.value;
        if (qtd && TAXAS_JUROS[qtd] !== undefined) {
            const taxa = TAXAS_JUROS[qtd];
            displayTaxa.textContent = `Taxa aplicada automaticamente: ${taxa.toString().replace('.',',')}%`;
            displayTaxa.style.color = '#2ecc71'; // verde sucesso
        } else {
            displayTaxa.textContent = '';
        }
    });

    // Funções auxiliares de erro
    function limparErros() {
      document.querySelectorAll('.error, .msg-erro').forEach(el => 
        el.classList.contains('msg-erro') ? el.remove() : el.classList.remove('error')
      );
    }

    function erroNo(campo, msg) {
      campo.classList.add('error');
      const p = document.createElement('p');
      p.className = 'msg-erro';
      p.textContent = msg;
      campo.insertAdjacentElement('afterend', p);
    }

    // 3. O Evento de Calcular
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      limparErros();
      resultado.innerHTML = '';

      // Captura valores
      const valorProduto = parseFloat(elProduto.value.replace(',', '.'));
      let valorEntrada = parseFloat(elEntrada.value.replace(',', '.'));
      if (isNaN(valorEntrada)) valorEntrada = 0; // Se deixar vazio, considera 0

      const qtdParcelas = parseInt(selectParcelas.value, 10);
      
      // Validações
      let ok = true;
      if (isNaN(valorProduto) || valorProduto <= 0) {
        ok = false; erroNo(elProduto, 'Informe o valor do produto.');
      }
      if (valorEntrada < 0) {
        ok = false; erroNo(elEntrada, 'Valor de entrada inválido.');
      }
      if (valorEntrada >= valorProduto) {
        ok = false; erroNo(elEntrada, 'A entrada deve ser menor que o valor do produto.');
      }
      if (!qtdParcelas || !TAXAS_JUROS[qtdParcelas]) {
        ok = false; erroNo(selectParcelas, 'Selecione uma opção de parcelamento.');
      }

      if (!ok) return;

      // CÁLCULO (Conforme sua fórmula)
      const taxa = TAXAS_JUROS[qtdParcelas];
      const taxaDecimal = taxa / 100;
      
      const saldo = valorProduto - valorEntrada;
      
      // Fórmula: ((saldo) * (1 + taxaDecimal)) / parcelas;
      const totalComJuros = saldo * (1 + taxaDecimal);
      const valorParcela = totalComJuros / qtdParcelas;
      const jurosTotal = totalComJuros - saldo;

      // Exibição do Resultado
      resultado.innerHTML = `
        <div class="resultado-destacado">
          <strong>${qtdParcelas}x de ${fmtBRL.format(valorParcela)}</strong><br/>
          <span class="muted" style="font-size: 0.9em">
            (Taxa: ${taxa.toString().replace('.',',')}%)<br/>
            Saldo financiado: ${fmtBRL.format(saldo)} •
            Juros totais: ${fmtBRL.format(jurosTotal)}<br/>
            <strong>Total a pagar: ${fmtBRL.format(totalComJuros)}</strong>
          </span>
        </div>
      `;

      resultado.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
  </script>
</body>
</html>
