<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Parcelamento</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Pequeno ajuste para destacar a taxa aplicada */
    .info-taxa {
      font-size: 0.9em;
      color: #555;
      margin-top: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculadora de Parcelamento</h1>

    <form id="calcForm" novalidate>
      <fieldset>
        <legend>Origem do Valor do Produto</legend>

        <label for="origemValor">Escolha a origem:</label>
        <select id="origemValor" name="origemValor">
          <option value="manual" selected>Valor manual</option>
          <option value="catalogo">Catálogo (Google Sheets)</option>
        </select>

        <div id="campoManual" class="origem-campo">
          <label for="valorProdutoManual">Valor do Produto (R$):</label>
          <input type="number" id="valorProdutoManual" name="valorProdutoManual" min="0" step="0.01" required placeholder="Ex.: 3997,00"/>
        </div>

        <div id="campoCatalogo" class="origem-campo" hidden>
          <label for="produtoPlanilha">Produto do catálogo:</label>
          <select id="produtoPlanilha" name="produtoPlanilha" disabled>
            <option value="">Selecione um produto</option>
          </select>
          <p id="statusCatalogo" class="muted" aria-live="polite"></p>
        </div>
      </fieldset>

      <div>
        <label for="valorEntrada">Valor de Entrada (R$):</label>
        <input type="number" id="valorEntrada" name="valorEntrada" min="0" step="0.01" required placeholder="Ex.: 500,00"/>
        <p class="muted">A entrada será abatida do valor do produto antes do cálculo dos juros.</p>
      </div>

      <div>
        <label for="parcelas">Opção de Parcelamento:</label>
        <select id="parcelas" name="parcelas" required>
            <option value="">Selecione a quantidade...</option>
            </select>
        <div id="displayTaxa" class="info-taxa"></div>
      </div>

      <button type="submit">Calcular Parcelas</button>
      
      <div id="resultado" aria-live="polite"></div>
    </form>
  </div>

  <script>
    // ============================================================
    // ÁREA DE CONFIGURAÇÃO MANUAL DAS TAXAS
    // ============================================================
    // Edite os valores à direita (em porcentagem)
    const TAXAS_JUROS = {
        2:  5.11,   // 2x
        3:  6.85,   // 3x
        4:  8.62,   // 4x
        5:  10.39,   // 5x
        6:  12.19,  // 6x
        7:  14.01,  // 7x
        8:  15.85,  // 8x
        9:  17.70,  // 9x
        10: 19.58,  // 10x
        11: 21.47,  // 11x
        12: 23,28   // 12x
    };
    // ============================================================

    // formatador em Real
    const fmtBRL = new Intl.NumberFormat('pt-BR', {
      style: 'currency', currency: 'BRL'
    });

    const form = document.getElementById('calcForm');
    const resultado = document.getElementById('resultado');
    const origemValor = document.getElementById('origemValor');
    const produtoPlanilha = document.getElementById('produtoPlanilha');
    const valorProdutoManual = document.getElementById('valorProdutoManual');
    const campoCatalogo = document.getElementById('campoCatalogo');
    const campoManual = document.getElementById('campoManual');
    const statusCatalogo = document.getElementById('statusCatalogo');
    
    // Novos elementos
    const selectParcelas = document.getElementById('parcelas');
    const displayTaxa = document.getElementById('displayTaxa');

    // 1. Preencher o Select de parcelas ao carregar a página
    function iniciarOpcoesParcelamento() {
        // Limpa opções atuais (mantendo a primeira)
        selectParcelas.innerHTML = '<option value="">Selecione a quantidade...</option>';
        
        // Percorre a tabela de configuração e cria as opções
        for (const [qtd, taxa] of Object.entries(TAXAS_JUROS)) {
            const option = document.createElement('option');
            option.value = qtd;
            option.textContent = `${qtd}x (Taxa: ${taxa.toString().replace('.',',')}%)`;
            selectParcelas.appendChild(option);
        }
    }
    iniciarOpcoesParcelamento();

    // 2. Atualizar o texto da taxa quando o usuário mudar a parcela
    selectParcelas.addEventListener('change', function() {
        const qtd = this.value;
        if (qtd && TAXAS_JUROS[qtd] !== undefined) {
            const taxa = TAXAS_JUROS[qtd];
            displayTaxa.textContent = `Taxa aplicada automaticamente: ${taxa.toString().replace('.',',')}%`;
            displayTaxa.style.color = '#2ecc71'; // verde
        } else {
            displayTaxa.textContent = '';
        }
    });

    const PLANILHA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9Q6g7xyPjdJawVSKuGInxjeRGna43EIBgzHuLlHotE5_m7V6czS4_iFqqpwYBFvTo95OfzmiSnJeA/pub?output=csv';
    let catalogoCarregado = false;

    async function carregarProdutosCatalogo() {
      if (catalogoCarregado) return;

      statusCatalogo.textContent = 'Carregando produtos…';
      produtoPlanilha.innerHTML = '<option value="">Carregando…</option>';
      produtoPlanilha.disabled = true;

      try {
        const resposta = await fetch(PLANILHA_URL);
        if (!resposta.ok) {
          throw new Error('Não foi possível carregar o catálogo.');
        }

        const csv = await resposta.text();
        const linhas = csv.trim().split(/\r?\n/).filter(Boolean);
        const itens = linhas.slice(1); // remove cabeçalho

        produtoPlanilha.innerHTML = '<option value="">Selecione um produto</option>';

        itens.forEach(linha => {
          const delimitador = linha.includes(';') ? ';' : ',';
          const colunas = linha.split(delimitador);
          const nome = (colunas[0] || '').trim();
          const precoBruto = (colunas[1] || '').trim();
          const precoNormalizado = precoBruto.replace(/[^0-9,.-]/g, '').replace(',', '.');
          const preco = parseFloat(precoNormalizado);

          if (!nome || Number.isNaN(preco)) {
            return;
          }

          const option = document.createElement('option');
          option.value = nome;
          option.dataset.preco = String(preco);
          option.textContent = `${nome} — ${fmtBRL.format(preco)}`;
          produtoPlanilha.appendChild(option);
        });

        if (produtoPlanilha.options.length === 1) {
          statusCatalogo.textContent = 'Nenhum item disponível no catálogo.';
        } else {
          statusCatalogo.textContent = '';
        }

        produtoPlanilha.disabled = produtoPlanilha.options.length === 1;
        catalogoCarregado = true;
      } catch (erro) {
        statusCatalogo.textContent = erro.message || 'Ocorreu um erro ao carregar a planilha.';
        produtoPlanilha.innerHTML = '<option value="">Erro ao carregar</option>';
        produtoPlanilha.disabled = true;
      }
    }

    function atualizarOrigemValor() {
      const origem = origemValor.value;
      limparErros();
      resultado.innerHTML = '';

      if (origem === 'catalogo') {
        campoCatalogo.hidden = false;
        campoManual.hidden = true;
        valorProdutoManual.value = '';
        valorProdutoManual.required = false;
        valorProdutoManual.disabled = true;
        produtoPlanilha.disabled = true;
        produtoPlanilha.required = true;
        carregarProdutosCatalogo();
      } else {
        campoCatalogo.hidden = true;
        campoManual.hidden = false;
        produtoPlanilha.value = '';
        produtoPlanilha.disabled = true;
        produtoPlanilha.required = false;
        valorProdutoManual.disabled = false;
        valorProdutoManual.required = true;
        valorProdutoManual.value = '';
      }
    }

    origemValor.addEventListener('change', atualizarOrigemValor);
    atualizarOrigemValor();

    function limparErros() {
      document
        .querySelectorAll('.error, .msg-erro')
        .forEach(el => el.classList.contains('msg-erro') ? el.remove() : el.classList.remove('error'));
    }

    function erroNo(campo, msg) {
      campo.classList.add('error');
      const p = document.createElement('p');
      p.className = 'msg-erro';
      p.textContent = msg;
      campo.insertAdjacentElement('afterend', p);
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      limparErros();
      resultado.innerHTML = '';

      const origem = origemValor.value;
      let valorProduto = NaN;

      if (origem === 'catalogo') {
        const opcaoSelecionada = produtoPlanilha.selectedOptions[0];
        if (opcaoSelecionada && opcaoSelecionada.dataset.preco) {
          valorProduto = parseFloat(opcaoSelecionada.dataset.preco);
        }
      } else {
        valorProduto = parseFloat(valorProdutoManual.value.replace(',', '.'));
      }
      const valorEntrada = parseFloat(document.getElementById('valorEntrada').value.replace(',', '.'));
      
      // MUDANÇA: Pegar parcelas e juros da tabela, não de inputs manuais
      const qtdParcelas = parseInt(selectParcelas.value, 10);
      
      // Validações básicas
      let ok = true;
      if (Number.isNaN(valorProduto) || valorProduto <= 0) {
        ok = false;
        if (origem === 'catalogo') {
          erroNo(produtoPlanilha, 'Selecione um produto válido.');
        } else {
          erroNo(valorProdutoManual, 'Informe um valor de produto válido.');
        }
      }
      
      if (isNaN(valorEntrada) || valorEntrada < 0) {
        ok = false; erroNo(document.getElementById('valorEntrada'), 'Entrada inválida.');
      }
      
      if (valorEntrada > valorProduto) {
        ok = false; erroNo(document.getElementById('valorEntrada'), 'A entrada não pode ser maior que o valor do produto.');
      }
      
      // Valida se selecionou uma parcela da lista
      if (!qtdParcelas || !TAXAS_JUROS[qtdParcelas]) {
        ok = false; erroNo(selectParcelas, 'Selecione uma opção de parcelamento.');
      }

      if (!ok) return;

      // LÓGICA DE CÁLCULO AUTOMÁTICA
      const taxaAplicada = TAXAS_JUROS[qtdParcelas]; // Pega da tabela
      const taxaDecimal = taxaAplicada / 100;
      
      const saldo = valorProduto - valorEntrada;
      const valorParcela = ((saldo) * (1 + taxaDecimal)) / qtdParcelas;
      const totalComJuros = valorParcela * qtdParcelas;
      const jurosTotal = totalComJuros - saldo;

      resultado.innerHTML = `
        <div class="resultado-destacado">
          <strong>${qtdParcelas}x de ${fmtBRL.format(valorParcela)}</strong><br/>
          <span class="muted" style="font-size: 0.9em">
            (Taxa aplicada: ${taxaAplicada.toString().replace('.',',')}%)<br/>
            Saldo financiado: ${fmtBRL.format(saldo)} •
            Juros totais: ${fmtBRL.format(jurosTotal)} •
            Total a pagar: ${fmtBRL.format(totalComJuros)}
          </span>
        </div>
      `;

      resultado.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
  </script>
</body>
</html>
